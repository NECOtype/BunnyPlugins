---
import Layout from '@layouts/Base.astro';
import FontPage from '@layouts/FontArticle.astro';

import { getCollection, render } from 'astro:content';
import { sluggit } from '@lib/utils';
import type { CollectionEntry } from 'astro:content';

import { shouldServeJson } from '@lib/request';
import fs from 'node:fs/promises';
import path from 'node:path';

export async function getStaticPaths() {
	const fonts = await getCollection("font");
	return fonts.map(font => ({
		params: { id: font.data.slug || sluggit(font.data.title) },
		props: font,
	}))
}

type Props = CollectionEntry<"font">;

const post = Astro.props;


if (shouldServeJson(Astro.request)) {
	const manifestPath = path.join("src/conent/fonts", post.data.slug || sluggit(post.data.title), `${post.data.slug}.json`)
	const json = await fs.readFile(manifestPath, "utf-8");

	return new Response(json, {
		status: 200,
		headers: {
			"Content-Type": "application/json",
		}
	});
}

const { Content } = await render(post);
---

<Layout title=`Fonts - ${post.data.title}`>
	<FontPage {...post.data}>
		<Content />
	</FontPage>
</Layout>

<style>
</style>